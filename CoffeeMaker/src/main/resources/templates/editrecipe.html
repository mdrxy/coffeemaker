<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <head>
        <!-- Standard Meta -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

        <!-- Site Properties -->
        <title>Edit Recipe</title>

        <script src="js/jquery.js"></script>
        <link rel="stylesheet" type="text/css" href="css/semantic.css">
        <script src="js/semantic.js"></script>
        <script src="js/app.js"></script>
        <link rel="stylesheet" href="css/app.css" />
    </head>

    <body>
        <!-- Modal templates -->
        <div th:insert="modals :: modals"></div>

        <div class="wrapper">
            <div class="content">
                <div id="contentBody" class="ui grid middle aligned container">
                    <div class="column">
                        <h1 class="ui centered header">Edit Recipe</h1>

                        <!-- Input -->
                        <form id="editRecipeForm" class="ui form">                            
                            <!-- Select Recipe -->
                            <div class="ui three column centered stackable grid container">
                                <div class="left aligned column">
                                    <div class="required field">
                                        <label>Select Recipe</label>
                                        <div id="recipeDropdown" class="ui search selection dropdown">
                                            <i class="dropdown icon"></i>
                                            <input name="recipes" type="hidden">
                                            <div class="text"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="ui two column stackable grid container">
                                <!-- Name and price -->
                                <div class="column">
                                    <div class="fields">
                                        <div class="nine wide field">
                                            <label>Name</label>
                                            <div class="ui input">
                                                <input id="nameInputPlaceholder" placeholder="" readonly="" name="name">
                                            </div>
                                        </div>

                                        <div class="seven wide field required">
                                            <label>Price</label>
                                            <div class="ui right labeled left icon input">
                                                <i class="dollar icon"></i>
                                                <input type="number" placeholder="1" min="1" max="1000" name="price" id="price"
                                                    aria-label="Amount (to the nearest dollar)">
                                                <div class="ui basic label">.00</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ingredients -->
                                <div class="column">
                                    <div class="required field">
                                        <label>Select Ingredients</label>
                                        <div id="ingredientDropdown" class="ui clearable multiple search selection dropdown">
                                            <i class="dropdown icon"></i>
                                            <!-- Hidden input needed for validation -->
                                            <input type="hidden" name="ingredient">
                                            <div class="text"></div>
                                        </div>
                                    </div>
                                
                                    <div class="compact negative basic ui animated fade right floated button clearIngredients">
                                        <div class="visible content">
                                            Clear Ingredients
                                        </div>
                                        <div class="hidden content">
                                            <i class="x icon"></i>
                                        </div>
                                    </div>
                                
                                    <!-- Selected Ingredients list -->
                                    <div class="field" id="ingredientList">
                                        <!-- Populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Submit -->
                            <div class="ui centered grid">
                                <div class="six wide column">
                                    <button id="submitButton" class="fluid ui primary labeled icon disabled button">
                                        <i class="plus icon"></i>
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </form>

                        <!-- Messages (hide/show these dynamically) -->
                        <div class="ui icon success message hidden" id="success">
                            <i class="check icon"></i>
                            <div class="content">
                                <div class="header"><span id="successRecipeName"></span> edited successfully!</div>
                                <p>Time to <a class="makeCoffee" href="makecoffee.html">make some coffee</a>... ☕️</p>
                            </div>
                        </div>
                        <div class="ui icon error message hidden" id="errorPrice">
                            <i class="x icon"></i>
                            <div class="content">
                                <div class="header">Invalid price</div>
                                <p>Must be a positive integer</p>
                            </div>
                        </div>
                        <div class="ui icon error message hidden" id="errorIngredients">
                            <i class="x icon"></i>
                            <div class="content">
                                <div class="header">Invalid recipe</div>
                                <p>No ingredients</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="ui bottom fixed borderless menu">
            <div class="item">
                <div class="spaced buttons">
                    <div th:insert="footerLinks :: pages"></div>
                </div>
            </div>
        
            <div class="right menu">
                <div class="item">
                    <div th:insert="footerLinks :: homePage"></div>
                </div>
            </div>
        </footer>

        <script>
            const successMessageElement = document.getElementById('success');
            const priceErrorMessageElement = document.getElementById('errorPrice');
            const ingredientsErrorMessageElement = document.getElementById("errorIngredients");
            const submitButton = document.getElementById('submitButton');
            var recipes = [];

            // Fetch a Recipe object from the list
            function getRecipe(name) {
                for (var i = 0; i < recipes.length; i++) {
                    if (recipes[i].name === name) {
                        return { name: recipes[i].name, price: recipes[i].price, 
                            ingredients: recipes[i].ingredients };
                    }
                }

                return null;
            }

            // Initialize the list of Recipes
            function fetchRecipes() {
                $.get("/api/v1/recipes")
                    .done(function (data) {
                        if (data && data.length > 0) {

                            // Extract Recipe names from returned data
                            var recipeNames = data.map(function (recipe) {
                                return {
                                    name: recipe.name.split(' ').map(word => word.charAt(0).toUpperCase()
                                        + word.slice(1)).join(' '), price: recipe.price, ingredients: recipe.ingredients
                                };
                            });

                            recipes = data;
                        } else if (data.length == 0) {
                            noRecipes();
                        }
                    })
                    .fail(function (xhr, status, error) {
                        handleAPIError(xhr, status, error);
                    });
            }

            // Initialize the dropdown with a sorted & capitalized list of Ingredient names
            function fetchIngredients() {
                $.get("/api/v1/inventory")
                    .done(function (data) {
                        if (data && data.ingredients && data.ingredients.length >= 0) {

                            // Extract Ingredient names from returned data
                            var ingredientNames = data.ingredients.map(function (ingredient) {
                                // Necessary to capitalize names here instead of via CSS due to rendering delay
                                return {
                                    name: ingredient.name.split(' ').map(word => word.charAt(0).toUpperCase()
                                        + word.slice(1)).join(' '), value: ingredient.name
                                };
                            });

                            // Sort the ingredientNames array by name (alphabetically) before initializing the dropdown menu
                            ingredientNames.sort(function (a, b) {
                                return a.name.localeCompare(b.name);
                            });

                            // Initialize dropdown
                            $('#ingredientDropdown').dropdown('setup menu', { values: ingredientNames });
                        }
                    })
                    .fail(function (xhr, status, error) {
                        handleAPIError(xhr, status, error);
                    });
            }

            // Fire on page load
            $(document).ready(function () {
                // Fetch Recipes from the server
                fetchRecipes();
                
                // Fetch Ingredient data from the server
                fetchIngredients();

                // Aesthetic: clearing necessary due to bug @ https://github.com/fomantic/Fomantic-UI/issues/2837
                // Wherein the placeholder text doesn't render initially
                $('#recipeDropdown').dropdown('clear')
                $('#ingredientDropdown').dropdown('clear')
            });

            // Button to clear selected Ingredients
            $('.clearIngredients').on('click', function () {
                $('#ingredientDropdown').dropdown('clear');
            });

            // (Helper) clear entire form
            function clearForm() {
                var form = document.getElementById("editRecipeForm");
                if (form) {
                    for (var i = 0; i < form.elements.length; i++) {
                        var element = form.elements[i];
                        // Check if the element is an input field or textarea
                        if (element.tagName === "INPUT" || element.tagName === "TEXTAREA") {
                            // Clear the value of the element
                            element.value = "";
                        }
                    }
                }
            }

            // Fetch Recipes and update dropdown and local list
            $('#recipeDropdown').dropdown({
                showOnFocus: true,
                placeholder: 'All Recipes',
                filterRemoteData: true,
                apiSettings: {
                    url: 'api/v1/recipes',
                    cache: false,
                    onResponse: function (APIresponse) {
                        var response = { results: [] }

                        if (APIresponse && APIresponse.length >= 1) {
                            APIresponse.forEach(function (item) {
                                var resultItem = {
                                    name: item.name.split(' ').map(word => word.charAt(0).toUpperCase()
                                        + word.slice(1)).join(' '),
                                    value: item.name.split(' ').map(word => word.charAt(0).toUpperCase()
                                        + word.slice(1)).join(' ')
                                };

                                response.results.push(resultItem);
                            });
                        } else {
                            noRecipes();
                        }

                        return response;
                    },
                    onFailure: function (response, element, xhr) {
                        handleAPIError(response, element, xhr);
                    }
                },

                onChange: function (value, text, $selectedItem) {
                    // Reset between selections since this persists (not handled by form clearing)
                    $('#ingredientDropdown').dropdown('clear');

                    const recipe = getRecipe(text.toLowerCase());

                    $('#editRecipeForm').form('set values', {
                        name: recipe.name,
                        price: recipe.price
                    });

                    var ingredientNames = [];
                    var ingredientQuantities = {};
                    recipe.ingredients.forEach(function (ingredient) {
                        let name = ingredient.name;
                        
                        ingredientNames.push(name);

                        let key = name + "_quantity";

                        ingredientQuantities[key] = ingredient.quantity;
                    });

                    // Add new selection
                    $('#ingredientDropdown').dropdown('set selected', (ingredientNames));
                    $('#editRecipeForm').form('set values', ingredientQuantities);

                    submitButton.classList.remove("disabled");
                }
            });

            // Dropdown multi select search menu behavior
            $('#ingredientDropdown').dropdown({
                showOnFocus: true,
                clearable: true, // Needed for https://github.com/fomantic/Fomantic-UI/issues/2837
                placeholder: 'All Ingredients',

                // Each time a selection is made
                onAdd: function (value, text, $selectedItem) {
                    var ingredientFieldWrapper = document.createElement("div");
                    ingredientFieldWrapper.classList.add("ingredient", "field");
                    ingredientFieldWrapper.setAttribute("data-value", value);

                    var ingredientFields = document.createElement("div");
                    ingredientFields.classList.add("two", "fields");

                    var ingredientNameField = document.createElement("div");
                    ingredientNameField.classList.add("ingredient", "field");
                    // Might be able to remove ingredient from this

                    var nameLabel = document.createElement("label");
                    nameLabel.textContent = "Ingredient";

                    var ingredientInput = document.createElement("div");
                    ingredientInput.classList.add("ui", "input");

                    var ingredientInputElement = document.createElement("input");
                    ingredientInputElement.classList.add("ingredientName");
                    ingredientInputElement.placeholder = text;
                    ingredientInputElement.readOnly = "";
                    ingredientInputElement.type = "text";
                    ingredientInputElement.tabIndex = "-1";

                    var quantityField = document.createElement("div");
                    quantityField.classList.add("quantity", "field", "required");

                    var quantityLabel = document.createElement("label");
                    quantityLabel.textContent = "Quantity";

                    var quantityInputElement = document.createElement("input");
                    quantityInputElement.placeholder = "1";
                    quantityInputElement.min = "1";
                    quantityInputElement.type = "number";
                    quantityInputElement.required = true;
                    quantityInputElement.name = value + "_quantity";

                    ingredientInput.appendChild(ingredientInputElement);

                    ingredientNameField.appendChild(nameLabel);
                    ingredientNameField.appendChild(ingredientInput);

                    quantityField.appendChild(quantityLabel);
                    quantityField.appendChild(quantityInputElement);

                    ingredientFields.appendChild(ingredientNameField);
                    ingredientFields.appendChild(quantityField);

                    ingredientFieldWrapper.appendChild(ingredientFields);

                    ingredientList.appendChild(ingredientFieldWrapper);
                },
                onRemove: function (removedValue, removedText, $removedItem) {
                    var existingIngredient = document.querySelector('.ingredient[data-value="' + removedValue + '"]');
                    existingIngredient.remove(); // Gets rid of ingredient row displayed below dropdown
                    $('#ingredientDropdown').dropdown('remove active', removedValue); // Remove from dropdown
                }
            });

            $('#editRecipeForm')
                .form({
                    // Validation

                    // This isn't working consistently and I'm not entirely sure why
                    inline: true,
                    on: 'blur',
                    fields: {
                        recipes: {
                            identifier: 'recipes',
                            rules: [
                                {
                                    type: 'empty',
                                    prompt: 'You must choose a recipe to edit'
                                }
                            ]
                        },
                        price: {
                            identifier: 'price',
                            rules: [
                                {
                                    type: 'empty',
                                    prompt: 'Recipe price must not be empty'
                                },
                                {
                                    type: 'integer[1..1000]',
                                },
                                {
                                    type: 'maxValue[1000]',
                                    prompt: 'Recipe price must not exceed {ruleValue}'
                                }
                            ]
                        },
                        ingredient: {
                            identifier: 'ingredient',
                            rules: [
                                {
                                    type: 'empty',
                                    prompt: 'Recipe ingredient list must not be empty'
                                }
                            ]
                        }
                    }
                })

                // PUT updated Recipe
                .submit(function (e) {
                    e.preventDefault(); // Prevent the form from submitting normally due to our custom behavior

                    // Prevent messages from showing when hit submit
                    successMessageElement.classList.add('hidden');
                    priceErrorMessageElement.classList.add('hidden');
                    ingredientsErrorMessageElement.classList.add('hidden');

                    var formData = new FormData(this);
                    var formDataArray = Array.from(formData.entries());

                    var ingredients = [];
                    for (var i = 2; i < formDataArray.length; i++) {
                        var pair = formDataArray[i];
                        var name = pair[0];
                        var quantity = pair[1];

                        // Strip `_quantity`
                        name = name.replace("_quantity", "");
                        var ingredient = constructIngredient(name, quantity)
                        ingredients.push(ingredient)
                    }

                    ingredients.shift(); // Necessary to remove the hidden input (which is necessary for validation)
                    ingredients.shift(); // Necessary to remove ingredient field

                    // If after parsing the form data there are no Ingredients, show form error
                    if (ingredients.length == 0) {
                        ingredientsErrorMessageElement.classList.remove('hidden');
                        return;
                    }

                    var recipeName = $('input[name="name"]').val().toLowerCase();
                    var price = $('input[name="price"]').val();
                    var recipe = constructRecipe(ingredients, recipeName, price);

                    // PUT newly constructed Recipe
                    $.ajax({
                        url: `/api/v1/recipes/${recipeName}`,
                        contentType: 'application/json',
                        method: 'PUT',
                        data: JSON.stringify(recipe), // Data to be sent to the server
                        dataType: 'json', // Data type expected from the server

                        // Callback functions to handle response
                        success: function (response) {
                            console.log('Success:', response);
                            
                            // Dynamically update the success message with the newly added Recipe name
                            var recipeName = recipe.name;
                            $('#successRecipeName').text(recipeName);
                            
                            // Update messages
                            successMessageElement.classList.remove('hidden');
                            ingredientsErrorMessageElement.classList.add('hidden');
                            priceErrorMessageElement.classList.add('hidden');
                            
                            // clearForm();
                            // // Unselect chosen Ingredients
                            // $('#ingredientDropdown').dropdown('clear');

                            // // Unselect chosen Recipe
                            // $('#recipeDropdown').dropdown('clear');

                            // KNOWN BUG: forced to reload the page of reselecting the same Recipe to edit
                            fetchRecipes();
                            fetchIngredients();
                        },
                        error: function (xhr, status, error) {
                            successMessageElement.classList.add('hidden');
                            handleAPIError(xhr, status, error);
                        }
                    });
                });
        </script>
    </body>
</html>